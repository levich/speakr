# Руководство по установке

Это всестороннее руководство охватывает развертывание Speakr для продакшена, включая подробные опции конфигурации, настройку производительности и лучшие практики развертывания. В то время как руководство Quick Start быстро запускает вас, это руководство предоставляет все необходимое для надежного продакшен-развертывания.

## Понимание архитектуры Speakr

Перед погружением в установку полезно понять, как работает Speakr. Приложение интегрируется с внешними API для двух основных целей: сервисы транскрибации, которые преобразуют ваше аудио в текст, и сервисы генерации текста, которые питают функции, такие как сводки, заголовки и интерактивный чат. Speakr разработан для гибкости, поддерживая как облачные сервисы, такие как OpenAI, так и самодостаточные решения, работающие на вашей собственной инфраструктуре.

Speakr использует специфические форматы API-эндпоинтов для этих интеграций. Для транскрибации он поддерживает стандартный формат API OpenAI Whisper, используя эндпоинт `/audio/transcriptions`, который реализован OpenAI, OpenRouter и многими самодостаточными решениями. Альтернативно, для продвинутых функций, таких как идентификация говорящих, Speakr может подключаться к ASR веб-сервисам, которые предоставляют эндпоинт `/asr`. **Примечание: Использование опции ASR эндпоинта требует запуска дополнительного Docker контейнера** (`onerahmet/openai-whisper-asr-webservice`) вместе с Speakr - полные инструкции по настройке предоставлены в разделе [Запуск ASR сервиса для идентификации говорящих](#running-asr-service-for-speaker-diarization) ниже. Для генерации текста Speakr использует формат API OpenAI Chat Completions с эндпоинтом `/chat/completions`, который широко поддерживается различными провайдерами ИИ.

## Предварительные требования

Для продакшен-развертывания убедитесь, что ваша система соответствует этим требованиям. Вам понадобится Docker Engine версии 20.10 или выше и Docker Compose версии 2.0 или выше. Система должна иметь минимум 4 ГБ RAM, с 8 ГБ рекомендуется для оптимальной производительности, особенно если вы обрабатываете более длинные записи. Планируйте минимум 20 ГБ свободного дискового пространства для размещения записей и транскрипций, хотя фактические требования будут зависеть от ваших паттернов использования. Сервер должен иметь стабильное интернет-подключение для API-вызовов к сервисам транскрибации и ИИ, если вы не запускаете все локально.

## Выбор метода развертывания

У вас есть два основных варианта для развертывания Speakr. Первый и рекомендуемый подход - использование предварительно собранного Docker образа из Docker Hub, который не требует исходного кода и быстро запускает вас. Второй вариант - сборка из исходников, что полезно, если вам нужно изменить код или вы предпочитаете собирать свои собственные образы. Оба метода используют Docker Compose для оркестрации и управления.

## Стандартная установка с использованием предварительно собранного образа

### Шаг 1: Создание директории установки

Выберите подходящее местоположение для вашей установки Speakr. Эта директория будет содержать ваши файлы конфигурации и тома данных. Для продакшен-развертываний рекомендуется использовать выделенную директорию, такую как `/opt/speakr` или `/srv/speakr`, так как это обеспечивает четкое разделение от домашних директорий пользователей и следует стандартам иерархии файловой системы Linux.

```bash
mkdir -p /opt/speakr
cd /opt/speakr
```

Если вы просто тестируете или запускаете Speakr для личного использования, вы можете создать директорию в вашей домашней папке вместо этого. Местоположение не критично, но хранение всего организованно в одном месте упрощает управление.

### Шаг 2: Создание конфигурации Docker Compose

Создайте файл `docker-compose.yml` со следующей конфигурацией:

```yaml
services:
  app:
    image: learnedmachine/speakr:latest
    container_name: speakr
    restart: unless-stopped
    ports:
      - "8899:8899"
    env_file:
      - .env
    volumes:
      - ./uploads:/data/uploads
      - ./instance:/data/instance
```

Или загрузите пример конфигурации:

```bash
wget https://raw.githubusercontent.com/murtaza-nasir/speakr/master/config/docker-compose.example.yml -O docker-compose.yml
```

Политика перезапуска `unless-stopped` обеспечивает, что Speakr автоматически запускается после перезагрузки системы, если вы явно не остановили его. Тома монтируют локальные директории для постоянного хранения загрузок и файлов базы данных.

### Шаг 3: Конфигурация окружения

Конфигурация окружения - это место, где вы говорите Speakr, какие ИИ-сервисы использовать и как к ним подключаться. Загрузите соответствующий шаблон окружения на основе вашего выбора сервиса транскрибации. Этот шаблон содержит все переменные конфигурации с полезными комментариями, объясняющими каждую настройку.

#### Для OpenAI Whisper API

Если вы используете API Whisper от OpenAI или любой совместимый сервис, загрузите шаблон окружения Whisper:

```bash
wget https://raw.githubusercontent.com/murtaza-nasir/speakr/master/config/env.whisper.example -O .env
```

Теперь отредактируйте файл `.env`, чтобы добавить ваши ключи API и настроить параметры. Конфигурация организована в логические разделы. Сначала настройте модель генерации текста, которая питает сводки, заголовки и функции чата. OpenRouter рекомендуется здесь, потому что он предоставляет доступ к нескольким моделям ИИ по конкурентным ценам, но вы можете использовать любой сервис, совместимый с OpenAI:

```bash
TEXT_MODEL_BASE_URL=https://openrouter.ai/api/v1
TEXT_MODEL_API_KEY=sk-or-v1-your-key-here
TEXT_MODEL_NAME=openai/gpt-4o-mini
```

Если вы предпочитаете использовать OpenAI напрямую для генерации текста, просто измените базовый URL на `https://api.openai.com/v1` и используйте ваш ключ API OpenAI. Вы также можете использовать локальные модели через Ollama или LM Studio, указывая на `http://localhost:11434/v1` или подобное.

Далее настройте сервис транскрибации. Это то, что преобразует ваши аудиофайлы в текст:

```bash
TRANSCRIPTION_BASE_URL=https://api.openai.com/v1
TRANSCRIPTION_API_KEY=sk-your-openai-key-here
WHISPER_MODEL=whisper-1
```

#### Для пользовательского ASR эндпоинта с идентификацией говорящих

Если вы хотите идентификацию говорящих для определения того, кто говорит в ваших записях, вам нужно использовать ASR веб-сервис эндпоинт. **Это требует запуска дополнительного Docker контейнера** вместе с Speakr, но предоставляет мощные функции для транскрипций встреч и записей с несколькими говорящими.

**Опции ASR сервиса:**

1. **WhisperX ASR Service (Рекомендуется для голосовых профилей)** - Требуется для функций голосовых профилей на основе ИИ, использующих эмбеддинги говорящих
   - Репозиторий: [murtaza-nasir/whisperx-asr-service](https://github.com/murtaza-nasir/whisperx-asr-service)
   - Использует модель `pyannote/speaker-diarization-community-1` с эксклюзивной идентификацией говорящих
   - Поддерживает 256-мерные эмбеддинги говорящих для идентификации голосовых профилей
   - Лучшее выравнивание временных меток между говорящими и словами
   - **Требуется для:** Голосовых профилей, автоматического распознавания говорящих, эмбеддингов говорящих
   - **Файл окружения:** `config/env.whisperx.example`

2. **OpenAI Whisper ASR Webservice (Базовая идентификация говорящих)** - Для базовой идентификации говорящих без голосовых профилей
   - Репозиторий: [ahmetoner/openai-whisper-asr-webservice](https://github.com/ahmetoner/openai-whisper-asr-webservice)
   - Использует модель `pyannote/speaker-diarization-3.1`
   - Более простая настройка, менее ресурсоемкая
   - **Поддерживает:** Базовую идентификацию говорящих (Speaker 1, Speaker 2 и т.д.)
   - **Не поддерживает:** Голосовые профили, эмбеддинги говорящих, автоматическое распознавание говорящих
   - **Файл окружения:** `config/env.asr.example`

> **Важно:** Перед продолжением с этой конфигурацией вам нужно настроить один из контейнеров ASR сервиса. См. [Запуск ASR сервиса для идентификации говорящих](#running-asr-service-for-speaker-diarization) для полных инструкций по развертыванию обоих контейнеров вместе или отдельно.

Загрузите соответствующий шаблон конфигурации ASR:

```bash
# Для WhisperX ASR Service (с голосовыми профилями):
wget https://raw.githubusercontent.com/murtaza-nasir/speakr/master/config/env.whisperx.example -O .env

# ИЛИ для базового ASR (без голосовых профилей):
wget https://raw.githubusercontent.com/murtaza-nasir/speakr/master/config/env.asr.example -O .env
```

Конфигурация ASR включает пользовательский эндпоинт и говорит Speakr, где его найти:

```bash
USE_ASR_ENDPOINT=true

# Для WhisperX ASR Service:
ASR_BASE_URL=http://whisperx-asr:9000

# ИЛИ для базового ASR Webservice:
ASR_BASE_URL=http://whisper-asr:9000
```

ASR_BASE_URL зависит от вашей архитектуры развертывания:
- **Тот же Docker Compose стек:** Используйте имя сервиса (например, `http://whisperx-asr:9000` или `http://whisper-asr:9000`) - внутренняя сеть Docker
- **Отдельная машина:** Используйте полный URL с IP-адресом или доменным именем (например, `http://192.168.1.100:9000`)

Идентификация говорящих автоматически включается при использовании ASR эндпоинтов. Система будет идентифицировать разных говорящих в ваших записях и помечать их как Speaker 1, Speaker 2 и так далее. Вы можете опционально переопределить настройки обнаружения говорящих по умолчанию, раскомментировав и настроив ASR_MIN_SPEAKERS и ASR_MAX_SPEAKERS в вашем файле окружения.

### Шаг 4: Настройка системных параметров

Одно из удобств Speakr - автоматическое создание административного аккаунта. Вместо прохождения процесса регистрации вы определяете учетные данные администратора в вашем файле окружения, и Speakr создает аккаунт автоматически при первом запуске. Это обеспечивает, что вы можете войти немедленно без каких-либо дополнительных шагов настройки:

```bash
ADMIN_USERNAME=admin
ADMIN_EMAIL=admin@your-domain.com
ADMIN_PASSWORD=your-secure-password-here
```

Выберите надежный пароль для этого аккаунта, так как он имеет полный системный доступ, включая возможность управлять пользователями и просматривать все записи. Административный аккаунт особенный и не может быть создан через обычный процесс регистрации, только через эти переменные окружения.

Далее настройте, как приложение ведет себя. Эти настройки контролируют доступ пользователей и работу системы:

```bash
ALLOW_REGISTRATION=false
TIMEZONE="America/New_York"
LOG_LEVEL="INFO"
```

Установка `ALLOW_REGISTRATION=false` означает, что только администратор может создавать новые пользовательские аккаунты, что рекомендуется для частных установок, где вы хотите контролировать доступ. Если вы запускаете Speakr для группы или семьи, это предотвращает создание аккаунтов случайными людьми. Настройка часового пояса влияет на то, как даты и времена отображаются по всему интерфейсу, поэтому установите его на ваш локальный часовой пояс для удобства. Уровень логирования контролирует, сколько информации Speakr записывает в свои логи. Используйте `INFO` во время первоначальной настройки и тестирования, чтобы видеть, что происходит, затем переключитесь на `ERROR` для продакшена, чтобы уменьшить объем логов и улучшить производительность.

### Шаг 5: Настройка продвинутых функций

#### Обработка больших файлов

Одна из самых полезных функций Speakr - автоматическая обработка больших аудиофайлов. Многие API транскрибации имеют ограничения размера файлов, с лимитом OpenAI в 25 МБ, являющимся распространенным ограничением. Вместо принуждения вас вручную разделять файлы, Speakr обрабатывает это автоматически через интеллектуальное разбиение:

```bash
ENABLE_CHUNKING=true
CHUNK_LIMIT=20MB
CHUNK_OVERLAP_SECONDS=3
```

Когда разбиение включено, Speakr автоматически обнаруживает, когда файл превышает настроенный лимит, и разделяет его на меньшие части. Каждый фрагмент обрабатывается отдельно, и транскрипции бесшовно объединяются обратно вместе. Настройка перекрытия обеспечивает, что никакие слова не теряются на границах фрагментов, что особенно важно для непрерывной речи. Лимит фрагмента может быть указан как размер файла, такой как `20MB`, или как длительность, такая как `20m` для 20 минут, в зависимости от ограничений вашего API.

Эта функция применяется только при использовании стандартного метода API Whisper. Если вы используете ASR эндпоинт, разбиение не нужно, так как эти сервисы обычно обрабатывают большие файлы нативно.

#### Режим Inquire для семантического поиска

Режим Inquire преобразует Speakr из простого инструмента транскрибации в базу знаний всех ваших записей. Когда включено, вы можете искать по всем вашим транскрипциям, используя вопросы на естественном языке:

```bash
ENABLE_INQUIRE_MODE=true
```

С активным режимом Inquire Speakr создает эмбеддинги ваших транскрипций, которые обеспечивают семантический поиск. Это означает, что вы можете задавать вопросы, такие как "Когда мы обсуждали маркетинговый бюджет?" и находить релевантные записи, даже если эти точные слова не использовались. Функция требует дополнительной обработки во время транскрибации, но предоставляет мощные возможности поиска, которые становятся более ценными по мере роста вашей библиотеки записей.

#### Автоматическая обработка файлов

Функция автоматической обработки файлов, иногда называемая директорией "черной дыры", отслеживает назначенную папку на наличие новых аудиофайлов и автоматически обрабатывает их без ручного вмешательства. Это идеально для интеграции с записывающими устройствами, автоматизированными рабочими процессами или сценариями пакетной обработки:

```bash
ENABLE_AUTO_PROCESSING=true
AUTO_PROCESS_MODE=admin_only
AUTO_PROCESS_WATCH_DIR=/data/auto-process
AUTO_PROCESS_CHECK_INTERVAL=30
```

Когда включено, Speakr проверяет директорию наблюдения каждые 30 секунд на наличие новых аудиофайлов. Любые найденные файлы автоматически перемещаются в директорию загрузок и обрабатываются с использованием ваших настроек транскрибации. Режим `admin_only` назначает все обработанные файлы администратору, но вы также можете настроить его для многопользовательских сценариев с отдельными директориями для каждого пользователя.

Для использования этой функции вам нужно будет смонтировать дополнительный том в вашей конфигурации Docker Compose, что мы рассмотрим в следующих шагах.

### Шаг 6: Настройка директорий данных

Speakr нужны локальные директории для постоянного хранения ваших данных. Эти директории монтируются как Docker тома, обеспечивая, что ваши записи и база данных переживают обновления контейнеров и перезапуски:

```bash
mkdir -p uploads instance
chmod 755 uploads instance
```

Директория `uploads` хранит все ваши аудиофайлы и их транскрипции, организованные по пользователям. Директория `instance` содержит базу данных SQLite, которая отслеживает все ваши записи, пользователей и настройки. Установка разрешений на 755 обеспечивает, что Docker контейнер может читать и записывать в эти директории, поддерживая разумную безопасность.

Если вы используете функцию автоматической обработки файлов, создайте эту директорию также:

```bash
mkdir -p auto-process
chmod 755 auto-process
```

### Шаг 7: Запуск Speakr

Со всем настроенным, вы готовы запустить Speakr. Флаг `-d` запускает контейнер в отсоединенном режиме, что означает, что он продолжает работать в фоне:

```bash
docker compose up -d
```

В первый раз, когда вы запускаете эту команду, Docker загрузит образ Speakr из Docker Hub. Этот образ составляет приблизительно 3 ГБ и содержит все зависимости, необходимые для запуска Speakr, включая FFmpeg для обработки аудио и различные библиотеки Python. Время загрузки зависит от скорости вашего интернет-подключения.

Отслеживайте процесс запуска, чтобы убедиться, что все работает правильно:

```bash
docker compose logs -f app
```

Следите за логами на наличие сообщений об ошибках. Вы должны увидеть сообщения об инициализации базы данных, создании административного пользователя и, наконец, сообщение, указывающее, что приложение Flask работает на порту 8899. Нажмите Ctrl+C, чтобы прекратить следование логам (это не остановит контейнер, только просмотр логов).

### Шаг 8: Проверка установки

Откройте ваш веб-браузер и перейдите на `http://your-server:8899`, заменив `your-server` на ваш фактический адрес сервера или `localhost`, если вы запускаете локально. Вы должны увидеть страницу входа Speakr с его отличительным градиентным дизайном.

Войдите, используя учетные данные администратора, которые вы настроили в файле окружения. Если вход не удается, проверьте ваши Docker логи, чтобы убедиться, что административный пользователь был создан успешно. Иногда опечатки в файле окружения могут вызывать проблемы.

После входа протестируйте установку, создав тестовую запись или загрузив образец аудиофайла. Интерфейс записи должен показывать опции для микрофона, системного аудио или обоих. Попробуйте сначала загрузить небольшой аудиофайл, чтобы проверить, что ваши ключи API работают правильно. Процесс транскрибации должен завершиться в течение нескольких моментов для коротких файлов, и вы должны увидеть транскрибированный текст вместе с сгенерированной ИИ сводкой.

Если транскрибация терпит неудачу, проверьте Docker логи на ошибки аутентификации API или проблемы подключения. Распространенные проблемы включают неправильные ключи API, недостаточные кредиты API или проблемы сетевого подключения.

## Продвинутые сценарии развертывания

### Запуск ASR сервиса для идентификации говорящих

Если вам нужна идентификация говорящих для определения разных говорящих в ваших записях, вам нужно запустить ASR сервис вместе с Speakr. Есть два варианта в зависимости от того, нужны ли вам функции голосовых профилей:

#### Вариант 1: WhisperX ASR Service (Рекомендуется - Поддерживает голосовые профили)

**Используйте это, если вы хотите:**
- Голосовые профили говорящих на основе ИИ с автоматическим распознаванием
- 256-мерные эмбеддинги говорящих
- Лучшее выравнивание временных меток между говорящими и словами
- Эксклюзивную идентификацию говорящих для более чистых переходов между говорящими

**Предварительные требования:**
1. **Аккаунт Hugging Face и доступ к моделям** - Посетите и примите условия для ВСЕХ моделей:
   - [pyannote/speaker-diarization-community-1](https://huggingface.co/pyannote/speaker-diarization-community-1)
   - [pyannote/speaker-diarization-3.1](https://huggingface.co/pyannote/speaker-diarization-3.1)
   - [pyannote/segmentation-3.0](https://huggingface.co/pyannote/segmentation-3.0)

2. **Генерация HF токена** - Создайте токен доступа только для чтения в [Hugging Face Settings](https://huggingface.co/settings/tokens)

3. **Требования к GPU** - NVIDIA GPU с 14 ГБ+ VRAM для модели large-v3 (рекомендуется RTX 3090/4090)

**Инструкции по настройке:**

Клонируйте репозиторий WhisperX ASR Service:
```bash
git clone https://github.com/murtaza-nasir/whisperx-asr-service.git
cd whisperx-asr-service

# Скопируйте файл окружения
cp .env.example .env

# Отредактируйте .env и добавьте ваш токен Hugging Face
nano .env  # Установите HF_TOKEN=hf_xxxxx...

# Соберите и запустите
docker compose up -d

# Проверьте, что он работает
curl http://localhost:9000/health
```

См. [README WhisperX ASR Service](https://github.com/murtaza-nasir/whisperx-asr-service#readme) для подробных опций конфигурации, решения проблем и настройки производительности.

#### Вариант 2: OpenAI Whisper ASR Webservice (Только базовая идентификация говорящих)

**Используйте это, если вы:**
- Нуждаетесь только в базовой идентификации говорящих (Speaker 1, Speaker 2 и т.д.)
- Не нуждаетесь в голосовых профилях или эмбеддингах говорящих
- Хотите более простую настройку с меньшими требованиями к ресурсам

**Предварительные требования:**
1. **Аккаунт Hugging Face и доступ к моделям** - Посетите и примите условия:
   - [pyannote/speaker-diarization-3.1](https://huggingface.co/pyannote/speaker-diarization-3.1)
   - [pyannote/segmentation-3.0](https://huggingface.co/pyannote/segmentation-3.0)

2. **Генерация HF токена** - Создайте токен доступа только для чтения в [Hugging Face Settings](https://huggingface.co/settings/tokens)

**Инструкции по настройке:**

Посетите репозиторий [ahmetoner/whisper-asr-webservice](https://github.com/ahmetoner/whisper-asr-webservice) для полных инструкций по настройке.

#### Развертывание ASR сервиса с Speakr

После того, как вы выбрали и настроили ваш ASR сервис, вы можете развернуть его вместе с Speakr несколькими способами:

**Та же машина - Объединенный Docker Compose (Рекомендуется)**

Пример с WhisperX ASR Service (для голосовых профилей):

```yaml
services:
  whisperx-asr:
    build:
      context: ./whisperx-asr-service
      dockerfile: Dockerfile
    container_name: whisperx-asr-api
    restart: unless-stopped
    ports:
      - "9000:9000"
    environment:
      - DEVICE=cuda
      - COMPUTE_TYPE=float16
      - BATCH_SIZE=16
      - HF_TOKEN=your_huggingface_token_here
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      - whisperx-cache:/.cache
    networks:
      - speakr-network

  speakr:
    image: learnedmachine/speakr:latest
    container_name: speakr
    restart: unless-stopped
    ports:
      - "8899:8899"
    env_file:
      - .env
    volumes:
      - ./uploads:/data/uploads
      - ./instance:/data/instance
    depends_on:
      - whisperx-asr
    networks:
      - speakr-network

networks:
  speakr-network:
    driver: bridge

volumes:
  whisperx-cache:
    driver: local
```

В файле `.env` Speakr:
```bash
USE_ASR_ENDPOINT=true
ASR_BASE_URL=http://whisperx-asr:9000
```

> **Примечание для пользователей Mac:** Проброс GPU не работает на macOS из-за архитектуры Docker. Используйте режим CPU, установив `DEVICE=cpu` и `COMPUTE_TYPE=float32` в переменных окружения. ASR сервис будет использовать обработку CPU, что медленнее, но полностью функционально.

**Важно:** При запуске обоих сервисов в том же файле Docker Compose используйте имя сервиса (например, `whisperx-asr` или `whisper-asr`) в `ASR_BASE_URL`, а не `localhost` или IP-адрес.

#### Запуск сервисов в отдельных файлах Docker Compose

Если вы предпочитаете управлять сервисами независимо или добавляете ASR сервис к существующей установке Speakr, вы можете запустить их в отдельных файлах Docker Compose. Этот подход дает вам больше гибкости и работает независимо от того, находятся ли сервисы на той же машине или на разных машинах.

##### Вариант 1: Та же машина с общей сетью

Если оба сервиса работают на той же машине, вы можете использовать внутреннюю сеть Docker для связи:

Сначала создайте общую сеть Docker:

```bash
docker network create speakr-network
```

Создайте `docker-compose.asr.yml` для ASR сервиса:

```yaml
services:
  whisper-asr:
    image: onerahmet/openai-whisper-asr-webservice:latest-gpu
    container_name: whisper-asr-webservice
    ports:
      - "9000:9000"
    environment:
      - ASR_MODEL=distil-large-v3
      - ASR_COMPUTE_TYPE=int8
      - ASR_ENGINE=whisperx
      - HF_TOKEN=your_huggingface_token_here
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
              device_ids: ["0"]
    restart: unless-stopped
    networks:
      - speakr-network

networks:
  speakr-network:
    external: true
```

Обновите ваш `docker-compose.yml` Speakr для использования общей сети:

```yaml
services:
  app:
    image: learnedmachine/speakr:latest
    container_name: speakr
    restart: unless-stopped
    ports:
      - "8899:8899"
    env_file:
      - .env
    volumes:
      - ./uploads:/data/uploads
      - ./instance:/data/instance
    networks:
      - speakr-network

networks:
  speakr-network:
    external: true
```

В вашем файле `.env` используйте имя контейнера:
```bash
ASR_BASE_URL=http://whisper-asr-webservice:9000
```

##### Вариант 2: Отдельные машины

При запуске на разных машинах вам не нужна общая сеть. Каждый сервис работает независимо и общается по сети, используя IP-адреса или имена хостов.

На ASR сервере создайте `docker-compose.asr.yml`:

```yaml
services:
  whisper-asr:
    image: onerahmet/openai-whisper-asr-webservice:latest-gpu
    container_name: whisper-asr-webservice
    ports:
      - "9000:9000"  # Открыт для сети
    environment:
      - ASR_MODEL=distil-large-v3
      - ASR_COMPUTE_TYPE=int8
      - ASR_ENGINE=whisperx
      - HF_TOKEN=your_huggingface_token_here
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
              device_ids: ["0"]
    restart: unless-stopped
```

На сервере Speakr используйте стандартный `docker-compose.yml`:

```yaml
services:
  app:
    image: learnedmachine/speakr:latest
    container_name: speakr
    restart: unless-stopped
    ports:
      - "8899:8899"
    env_file:
      - .env
    volumes:
      - ./uploads:/data/uploads
      - ./instance:/data/instance
```

В вашем файле `.env` Speakr используйте IP-адрес или имя хоста ASR сервера:
```bash
# Используя IP-адрес
ASR_BASE_URL=http://192.168.1.100:9000

# Или используя имя хоста
ASR_BASE_URL=http://asr-server.local:9000
```

Запустите оба сервиса на их соответствующих машинах:

```bash
# На ASR сервере
docker compose -f docker-compose.asr.yml up -d

# На сервере Speakr
docker compose up -d
```

Убедитесь, что порт 9000 доступен между машинами (проверьте правила файрвола при необходимости).

## Соображения для продакшена

### Использование обратного прокси для SSL

Для продакшен-развертываний запуск Speakr за обратным прокси необходим для безопасности и включения всех функций. Функция записи в браузере, особенно захват системного аудио, требует HTTPS для работы из-за ограничений безопасности браузера. Обратный прокси обрабатывает SSL-терминацию, что означает, что он управляет сертификатами HTTPS, общаясь с Speakr по HTTP внутренне.

Вот полная конфигурация nginx для Speakr:

```nginx
server {
    listen 443 ssl http2;
    server_name speakr.yourdomain.com;

    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    location / {
        proxy_pass http://localhost:8899;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support for live features
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Timeouts for large file uploads
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name speakr.yourdomain.com;
    return 301 https://$server_name$request_uri;
}
```

Конфигурация WebSocket важна для функций реального времени в Speakr. Настройки таймаутов обеспечивают, что большие загрузки файлов не прерываются. Вы можете получить бесплатные SSL сертификаты от Let's Encrypt, используя Certbot, делая HTTPS доступным для всех.

### Стратегия резервного копирования

Регулярные резервные копии необходимы для продакшен-развертываний. Ваши данные Speakr состоят из трех критических компонентов, которые нужно резервировать: база данных SQLite в директории `instance`, аудиофайлы и транскрипции в директории `uploads`, и ваша конфигурация в файле `.env`.

Создайте скрипт резервного копирования, который захватывает все три компонента:

```bash
#!/bin/bash
BACKUP_DIR="/backup/speakr"
DATE=$(date +%Y%m%d_%H%M%S)

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Create the backup
tar czf "$BACKUP_DIR/speakr_backup_$DATE.tar.gz" \
    /opt/speakr/instance \
    /opt/speakr/uploads \
    /opt/speakr/.env

# Optional: Keep only last 30 days of backups
find "$BACKUP_DIR" -name "speakr_backup_*.tar.gz" -mtime +30 -delete

echo "Backup completed: speakr_backup_$DATE.tar.gz"
```

Сделайте скрипт исполняемым и запланируйте его с cron для автоматических ежедневных резервных копий:

```bash
chmod +x /opt/speakr/backup.sh
crontab -e
# Добавьте эту строку для ежедневных резервных копий в 2 AM:
0 2 * * * /opt/speakr/backup.sh
```

Для критических развертываний рассмотрите копирование резервных копий в удаленное хранилище или облачные сервисы для дополнительной избыточности. Сжатый размер резервной копии обычно намного меньше исходных данных, так как аудиофайлы хорошо сжимаются.

### Мониторинг и обслуживание

Проактивный мониторинг помогает предотвращать проблемы до того, как они повлияют на пользователей. Аудиофайлы могут потреблять значительное хранилище со временем, особенно если вы регулярно записываете длинные встречи. Настройте мониторинг дискового пространства с предупреждениями, когда использование превышает 80%. Простой подход к мониторингу использует cron с df:

```bash
#!/bin/bash
USAGE=$(df /opt/speakr | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $USAGE -gt 80 ]; then
    echo "Warning: Speakr disk usage is at ${USAGE}%" | mail -s "Speakr Disk Alert" admin@example.com
fi
```

Регулярно отслеживайте здоровье Docker контейнера и логи. Вы можете использовать встроенную функцию проверки здоровья Docker или внешние инструменты мониторинга. Проверяйте паттерны, такие как повторяющиеся сбои API, ошибки аутентификации или таймауты обработки. Также отслеживайте использование API и затраты с вашим провайдером сервиса транскрибации, так как затраты могут накапливаться при интенсивном использовании.

### Усиление безопасности

Продакшен-развертывания требуют дополнительных мер безопасности помимо конфигурации по умолчанию. Начните с обеспечения надежных паролей для всех аккаунтов, особенно административного аккаунта. Никогда не используйте пароли по умолчанию или простые пароли в продакшене.

Ограничьте сетевой доступ, используя правила файрвола. Если Speakr используется только внутри, ограничьте доступ диапазонами IP вашей организации:

```bash
# Пример использования ufw
ufw allow from 192.168.1.0/24 to any port 8899
ufw deny 8899
```

Внедрите ограничение скорости на уровне обратного прокси, чтобы предотвратить злоупотребления и истощение API. В nginx вы можете добавить:

```nginx
limit_req_zone $binary_remote_addr zone=speakr:10m rate=10r/s;
limit_req zone=speakr burst=20;
```

Держите Docker образ обновленным с последними патчами безопасности. Регулярно проверяйте обновления и планируйте окна обслуживания для обновлений. Всегда создавайте резервные копии перед обновлением и тестируйте обновления в промежуточной среде сначала, если возможно.

## Обновление Speakr

Поддержание Speakr обновленным обеспечивает, что у вас есть последние функции и патчи безопасности. Процесс обновления прост, но должен выполняться осторожно, чтобы избежать потери данных.

Сначала всегда создавайте резервную копию перед обновлением:

```bash
# Создайте резервную копию
tar czf speakr_backup_before_update.tar.gz uploads/ instance/ .env

# Получите последний образ
docker compose pull

# Остановите текущий контейнер
docker compose down

# Запустите с новым образом
docker compose up -d

# Проверьте логи, чтобы убедиться в успешном запуске
docker compose logs -f app
```

Процесс обновления сохраняет все ваши данные, так как они хранятся в смонтированных томах вне контейнера. Однако проверка заметок о выпуске важна, так как некоторые обновления могут требовать изменений конфигурации или иметь критические изменения, которые требуют внимания.

Если обновление вызывает проблемы, вы можете откатиться, указав предыдущую версию в вашем файле docker-compose.yml:

```yaml
image: learnedmachine/speakr:v1.2.3  # Замените на вашу предыдущую версию
```

## Решение распространенных проблем

### Контейнер не запускается

Когда контейнер не может запуститься, логи обычно говорят вам точно, что не так. Проверьте их сначала:

```bash
docker compose logs app
```

Распространенные проблемы запуска включают отсутствующие или неправильно сформированные файлы `.env`. Убедитесь, что ваш файл `.env` существует и имеет правильный синтаксис. Каждая строка должна быть `KEY=value` без пробелов вокруг знака равенства. Комментарии начинаются с `#`.

Конфликты портов - еще одна распространенная проблема. Проверьте, используется ли порт 8899:

```bash
netstat -tulpn | grep 8899
# Или на macOS:
lsof -i :8899
```

Если порт используется, либо остановите конфликтующий сервис, либо измените порт Speakr в docker-compose.yml.

### Сбои транскрибации

Сбои транскрибации обычно происходят из-за проблем конфигурации API. Проверьте Docker логи на конкретные сообщения об ошибках:

```bash
docker compose logs app | grep -i error
```

Распространенные проблемы транскрибации включают неправильные ключи API, которые показываются как ошибки аутентификации в логах. Дважды проверьте ваши ключи в файле `.env` и убедитесь, что они для правильного сервиса. Недостаточные кредиты API будут показываться как ошибки квоты или оплаты. Проверьте баланс вашего аккаунта с вашим провайдером API. Проблемы сетевого подключения появляются как таймауты подключения или сбои разрешения DNS.

Для ASR эндпоинтов проверьте, что сервис работает и доступен:

```bash
# Протестируйте подключение ASR эндпоинта
curl http://your-asr-service:9000/docs
```

Если используете Docker сеть с именами сервисов, помните, что контейнеры должны быть в той же сети для связи.

### Проблемы производительности

Медленная производительность может иметь несколько причин. Начните с проверки системных ресурсов:

```bash
# Проверьте использование памяти
free -h

# Проверьте дисковый ввод-вывод
iotop

# Проверьте использование ресурсов Docker
docker stats speakr
```

Если память ограничена, рассмотрите добавление swap пространства или обновление вашего сервера. Для проблем дискового ввода-вывода убедитесь, что вы используете SSD хранилище для директорий uploads и instance. Традиционные жесткие диски могут значительно замедлить операции, особенно с несколькими одновременными пользователями.

Для обработки больших файлов убедитесь, что разбиение правильно настроено. Без разбиения большие файлы могут таймаутиться или полностью терпеть неудачу. Размер фрагмента должен быть немного ниже лимита вашего API, чтобы учесть накладные расходы кодирования.

Если вы видите медленную транскрибацию с многими одновременными пользователями, вы можете достигать лимитов скорости API. Проверьте документацию вашего провайдера API на лимиты скорости и рассмотрите обновление вашего плана при необходимости.

### Проблемы записи в браузере

Если запись в браузере не работает, особенно системное аудио, наиболее распространенная причина - использование HTTP вместо HTTPS. Браузеры требуют безопасных подключений для захвата аудио из-за проблем конфиденциальности. Либо настройте SSL с обратным прокси, либо, только для локальной разработки, измените настройки безопасности вашего браузера, чтобы обрабатывать ваш локальный URL как безопасный.

В Chrome перейдите на `chrome://flags`, найдите "insecure origins" и добавьте ваш URL в список. Помните, что это снижает безопасность и должно использоваться только для разработки.

## Сборка из исходников

Если вам нужно изменить код Speakr или вы предпочитаете собирать свои собственные образы, вы можете собрать из исходников. Это требует клонирования репозитория и использования возможности сборки Docker.

Сначала клонируйте репозиторий и перейдите в него:

```bash
git clone https://github.com/murtaza-nasir/speakr.git
cd speakr
```

Измените docker-compose.yml для сборки локально вместо использования предварительно собранного образа:

```yaml
services:
  app:
    build: .  # Сборка из текущей директории
    image: speakr:custom  # Тег для вашей пользовательской сборки
    container_name: speakr
    restart: unless-stopped
    ports:
      - "8899:8899"
    env_file:
      - .env
    volumes:
      - ./uploads:/data/uploads
      - ./instance:/data/instance
```

Соберите и запустите вашу пользовательскую версию:

```bash
docker compose up -d --build
```

Флаг `--build` заставляет Docker пересобрать образ, даже если он существует. Это полезно, когда вы внесли изменения в код и хотите протестировать их.

## Оптимизация производительности

Для развертываний с высоким объемом или при обработке многих больших файлов оптимизация становится важной. Начните с выбора модели, если используете ASR. Модель distil-large-v3 предлагает отличный баланс скорости и точности. Для контента только на английском используйте варианты `.en`, которые быстрее и точнее для английского.

Оптимизируйте выделение ресурсов Docker для вашей рабочей нагрузки:

```yaml
services:
  app:
    image: learnedmachine/speakr:latest
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '4'
        reservations:
          memory: 4G
          cpus: '2'
```

Это обеспечивает, что Speakr имеет достаточно ресурсов, предотвращая при этом потребление всего на общих серверах.

Для производительности хранилища используйте SSD диски для Docker томов. База данных значительно выигрывает от быстрого случайного ввода-вывода, и обработка больших аудиофайлов намного быстрее с SSD. Если используете сетевое хранилище, убедитесь в низкой задержке подключений.

---

Далее: [Руководство пользователя](../user-guide/index.md) чтобы узнать, как использовать все функции Speakr
