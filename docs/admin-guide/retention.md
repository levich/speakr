---
layout: default
title: Хранение и автоматическое удаление
parent: Руководство администратора
nav_order: 7
---

# Автоматическое удаление и политики хранения

Этот документ описывает автоматизированную систему хранения и удаления для записей Speakr.

## Обзор

Система автоматического удаления предоставляет автоматизированное управление жизненным циклом для ваших записей, помогая вам:
- **Соответствовать политикам хранения данных** - Автоматически удалять записи после указанного периода хранения
- **Управлять хранилищем** - Предотвращать неограниченный рост аудиофайлов
- **Поддерживать критические данные** - Сохранять транскрипции и метаданные даже после удаления аудио
- **Защищать важные записи** - Освобождать конкретные записи от автоматического удаления

## Конфигурация

### Переменные окружения

Добавьте это в ваш файл `.env` для настройки автоматического удаления:

```bash
# Включить или отключить функцию автоматического удаления
ENABLE_AUTO_DELETION=false  # Установите в 'true' для включения

# Глобальный период хранения в днях (0 = отключено)
GLOBAL_RETENTION_DAYS=90    # Записи старше этого будут обработаны

# Режим удаления: что удалять
DELETION_MODE=full_recording  # Опции: 'audio_only' или 'full_recording'
```

### Режимы удаления

#### Режим только аудио (`DELETION_MODE=audio_only`)
- **Удаляет**: Только аудиофайл
- **Сохраняет**: Транскрипцию, сводку, заметки, метаданные
- **Случай использования**: Долгосрочное ведение записей с оптимизацией хранилища
- **Результат**: Записи появляются в виде "Archived", транскрипция остается доступной для поиска

#### Режим полной записи (`DELETION_MODE=full_recording`)
- **Удаляет**: Полную запись, включая аудио, транскрипцию, сводку, заметки
- **Сохраняет**: Ничего — запись постоянно удаляется
- **Случай использования**: Полное удаление данных для соответствия требованиям
- **Результат**: Запись полностью удаляется из системы

## Многоуровневая система хранения

Speakr использует иерархическую систему политик хранения:

### 1. Глобальное хранение (Системное)
Устанавливается через переменную окружения `GLOBAL_RETENTION_DAYS`. Применяется ко всем записям, если не переопределено.

```bash
GLOBAL_RETENTION_DAYS=90  # Все записи старше 90 дней
```

### 2. Хранение на основе тегов
Теги могут переопределять глобальный период хранения с пользовательскими периодами хранения. Это особенно мощно с групповыми тегами, где администраторы групп могут устанавливать политики хранения для контента их группы.

```
Глобальное: 90 дней
Тег "Legal Records": 2555 дней (7 лет)  # Более длительное хранение
Тег "Daily Standups": 14 дней  # Более короткое хранение
Непомеченные записи: Используют глобальное (90 дней)
```

Когда запись имеет несколько тегов с разными периодами хранения, применяется **самый короткий** период.

### 3. Защита на основе тегов
Отдельные теги могут защищать записи от автоматического удаления полностью.

**Пример иерархии:**
- Глобальное хранение: 90 дней
- Тег "Sprint Reviews": 180 дней (дольше глобального)
- Тег "Daily Standups": 14 дней (короче глобального)
- Тег "Legal" с включенной защитой: Никогда не удаляется (постоянно)

## Защита записей от удаления

1. Перейдите в **Настройки аккаунта** → Вкладка **Tags**
2. Нажмите **Create Tag** или **Edit** существующего тега
3. Включите флажок **"Protect from Auto-Deletion"**
4. Примените этот тег к записям, которые хотите защитить

**Когда защищено:**
- ✅ Записи с защищенными тегами освобождаются от автоматического удаления
- ✅ Работает независимо от возраста или периода хранения
- ✅ Применяется ко всем записям с этим тегом

## Архивированные записи

Когда `DELETION_MODE=audio_only`, записи становятся "архивированными" после удаления аудио.

### Доступ к архивированным записям

1. Откройте боковую панель **Recordings**
2. Нажмите **Advanced Filters**
3. Переключите **"Archived Recordings"** ВКЛ

### Что вы можете делать с архивированными записями

| Функция | Доступна | Примечания |
|---------|----------|------------|
| Просмотр транскрипции | ✅ | Полный транскрипт доступен |
| Поиск контента | ✅ | Текстовый поиск все еще работает |
| Чтение сводки | ✅ | Сводка ИИ сохранена |
| Просмотр/редактирование заметок | ✅ | Все метаданные доступны |
| Воспроизведение аудио | ❌ | Аудиофайл удален |
| Повторная обработка | ❌ | Исходное аудио недоступно |
| Обмен | ✅ | Можно делиться транскрипцией |
| Экспорт | ✅ | Загрузить транскрипт, сводку, заметки |

### Индикаторы архивированных записей

- **Боковая панель**: Серый значок "Archived" рядом с заголовком записи
- **Плеер**: Информационный баннер: "Audio file has been deleted, but the transcription remains available"
- **Фильтр**: Отдельный переключатель вида "Archived" в расширенных фильтрах

## Административные элементы управления

### Запуск автоматического удаления

Автоматическое удаление запускается автоматически на основе настроенного расписания. Администраторы также могут запускать вручную:

**API Endpoint:**
```bash
POST /admin/auto-deletion/run
```

**Ответ:**
```json
{
  "checked": 150,
  "deleted_audio_only": 45,
  "deleted_full": 0,
  "exempted": 12,
  "errors": 0
}
```

### Проверка статистики автоматического удаления

**API Endpoint:**
```bash
GET /admin/auto-deletion/stats
```

**Ответ:**
```json
{
  "enabled": true,
  "global_retention_days": 90,
  "deletion_mode": "audio_only",
  "eligible_count": 45,
  "exempted_count": 12,
  "archived_count": 128
}
```

## Очистка данных говорящих

Когда записи автоматически удаляются, Speakr управляет связанными данными голосовых профилей говорящих для поддержания конфиденциальности и соответствия GDPR.

### Что очищается

Когда задача автоматического удаления запускается, система автоматически:

1. **Удаляет сиротские профили говорящих**: Говорящие без оставшихся записей удаляются полностью
2. **Очищает ссылки эмбеддингов**: ID записей удаляются из метаданных голосового профиля говорящего
3. **Применяется к обоим режимам удаления**: Работает как с `audio_only`, так и с `full_recording` режимами удаления

### Расписание очистки

Очистка говорящих запускается по тому же расписанию, что и автоматическое удаление:

- **Частота**: Ежедневно в 2:00 AM (время сервера)
- **Триггер**: Автоматически, когда `ENABLE_AUTO_DELETION=true`
- **Без дополнительной конфигурации**: Использует существующие настройки автоматического удаления

### Когда говорящие удаляются

Говорящий считается "сиротским" и удаляется, когда:

- Не существует записей `SpeakerSnippet` для говорящего (нет голосовых образцов ни в одной записи)
- Не осталось действительных ссылок на записи в метаданных голосового профиля говорящего
- Это происходит после того, как все записи, содержащие этого говорящего, были удалены

**Примечание**: Говорящие сохраняются, пока у них есть хотя бы одна активная запись с идентификацией говорящих.

### Конфиденциальность и соответствие GDPR

Эта автоматическая очистка обеспечивает:

- **Минимизацию данных**: Удаляет биометрические голосовые данные (эмбеддинги), когда они больше не нужны для функции системы
- **Право на удаление**: Удаляет личные данные (голосовые профили), когда записи удаляются
- **Прозрачность**: Активность очистки логируется для целей аудита
- **Без ручных действий**: Очистка происходит автоматически с политиками хранения

Система обрабатывает голосовые эмбеддинги как биометрические данные в соответствии с GDPR. Когда записи удаляются (либо через автоматическое удаление, либо ручное удаление), связанные данные голосового профиля оцениваются для удаления. Это обеспечивает соответствие правилам защиты данных без необходимости ручного вмешательства.

### Мониторинг активности очистки

Просматривайте статистику очистки в:

- **Системных логах**: Проверьте логи приложения на количество очистки и активность
- **Ответе автоматического удаления**: Количество очистки говорящих включено в вывод запланированной задачи

Пример записи лога:
```
INFO - Speaker cleanup completed: 5 speakers deleted, 12 embedding references removed
```

Процесс очистки включает эту статистику в ответ задачи автоматического удаления:

```json
{
  "checked": 123,
  "deleted_audio_only": 45,
  "deleted_full": 0,
  "exempted": 12,
  "speakers_deleted": 5,
  "embeddings_cleaned": 12,
  "speakers_evaluated": 94
}
```

### Какие данные сохраняются

Система сохраняет:

- **Активные говорящие**: Говорящие с хотя бы одной записью, содержащей их голос
- **Имена говорящих**: Имена сохраняются, пока существуют связанные записи
- **Голосовые профили**: Данные эмбеддингов сохраняются, когда записи ссылаются на говорящего

### Какие данные удаляются

Система удаляет:

- **Сиротские голосовые эмбеддинги**: Биометрические голосовые данные для говорящих без записей
- **Записи говорящих**: Весь профиль говорящего, когда полностью сиротский
- **Недействительные ссылки**: ID записей в истории эмбеддингов, которые указывают на удаленные записи
- **Статистика использования**: Количество использований и временные метки для удаленных говорящих

Это обеспечивает, что биометрические данные сохраняются только тогда, когда есть законная цель (активные записи), выполняя требование минимизации данных GDPR.

## Практические случаи использования

Система хранения решает реальные проблемы, которые люди имеют с накоплением записей. Вот как она используется:

### Личное использование

Вы записываете все в течение рабочего дня, чтобы захватить идеи и обсуждения. Большинство этих записей эфемерны — полезны в течение недели или двух, затем забыты. Установите 30-дневное глобальное хранение с удалением только аудио. Через месяц аудиофайлы исчезают, но доступные для поиска транскрипции остаются. Вы все еще можете найти то, что было сказано в старых записях, но вы не платите за хранение часов аудио, которые вы никогда больше не будете слушать.

Если что-то оказывается важным, пометьте это защищенным тегом до истечения 30 дней. Тег предотвращает удаление, сохраняя как аудио, так и транскрипт столько, сколько вам нужно.

### Групповое сотрудничество

Разные типы группового контента нуждаются в разных жизненных циклах:

| Тип контента | Подход к хранению | Почему |
|--------------|-------------------|--------|
| Ежедневные стендапы | Групповой тег с хранением 14 дней | Рутинные обновления, нет долгосрочной ценности |
| Планирование спринта | Групповой тег с хранением 90 дней | Справочная ценность для текущего квартала |
| Решения по архитектуре | Групповой тег с включенной защитой | Документировать важные выборы постоянно |
| Звонки клиентов (продажи) | Групповой тег с хранением 1 год | Длительность цикла продаж + окно последующих действий |
| Интервью (HR) | Групповой тег с хранением 2 года | Типичное окно трудовых споров |
| Юридические встречи | Защищенный тег | Неопределенное хранение для соответствия требованиям |

Каждая группа настраивает свои теги один раз с соответствующим хранением. Участники просто помечают записи нормально, и управление жизненным циклом происходит автоматически. Никому не нужно помнить, какие записи сохранять или удалять.

### Требования соответствия

Организации с политиками хранения данных могут применять их автоматически. Организация здравоохранения нуждается в 7-летнем хранении для консультаций пациентов — установите это в соответствующем групповом теге. Юридическая фирма нуждается в неопределенном хранении для встреч с клиентами — используйте защищенные теги. Финансовые услуги удаляют рутинные внутренние звонки через 90 дней, но хранят записи, связанные с соответствием требованиям, в течение 7 лет — разные теги с разным хранением.

Система применяет политику без требования, чтобы кто-то помнил правила. Пометите правильно, и хранение происходит автоматически.

### Управление затратами на хранилище

Аудиофайлы большие — часовая встреча может быть 50-100 МБ. Транскрипции — это текст — та же встреча может быть 10-20 КБ. Режим удаления только аудио сохраняет ценный доступный для поиска текст, освобождая хранилище.

Запустите удаление только аудио с хранением 90 дней. Записи старше 90 дней теряют свое аудио, но остаются полностью доступными для поиска. Вы все еще можете использовать режим Inquire для поиска информации, читать транскрипты, просматривать сводки и видеть заметки. Вы просто не можете воспроизвести оригинальное аудио. Для большинства случаев использования это нормально — как только вы извлекли информацию в текст, аудио не служит цели.

Этот подход позволяет вам хранить годы доступной для поиска истории бесед без накопления терабайтов аудиофайлов.

## Лучшие практики

### Для соответствия требованиям

1. **Установите соответствующие периоды хранения**
   ```bash
   # Пример: 7-летнее хранение для финансовых записей
   GLOBAL_RETENTION_DAYS=2555  # 7 лет × 365 дней
   DELETION_MODE=full_recording
   ```

2. **Используйте защиту на основе тегов** для записей, требующих неопределенного хранения
   - Создайте теги "Legal Hold" или "Permanent"
   - Включите защиту на этих тегах
   - Примените к релевантным записям

3. **Документируйте вашу политику хранения** в документации соответствия требованиям вашей организации

### Для управления хранилищем

1. **Начните с удаления только аудио**
   ```bash
   DELETION_MODE=audio_only
   ```
   - Сохраняет доступные для поиска транскрипции
   - Освобождает 95%+ хранилища (аудиофайлы большие)
   - Поддерживает бизнес-ценность бесед

2. **Используйте более короткие периоды хранения** для рутинных записей
   ```bash
   GLOBAL_RETENTION_DAYS=30  # Рутинные встречи
   ```

3. **Защищайте важный контент** тегами
   - Тег "Executive Meetings" → защита от удаления
   - Тег "Daily Standup" → без защиты (рутинное)

### Для групп

Когда группы включены:
1. **Установите консервативное глобальное хранение** (более короткий период как базовый)
2. **Настройте групповые теги с пользовательским хранением** для соответствия потребностям каждой группы
3. **Используйте защищенные групповые теги** для группового контента, требующего постоянного хранения
4. **Документируйте политики хранения** чтобы участники группы понимали ожидания жизненного цикла

Пример конфигурации хранения групповых тегов:
- Группа Engineering "Architecture Decisions": Защищено (никогда не удаляется)
- Группа Sales "Customer Calls": 365 дней
- Группа HR "Interviews": 90 дней
- Группа Operations "Daily Standups": 14 дней

## Процесс удаления

```
1. Автоматическая проверка (Ежедневно/Ручной триггер)
   ↓
2. Найти записи старше периода хранения
   ↓
3. Для каждой записи:
   - Проверить флаг ручного освобождения
   - Проверить теги на защиту
   - Пропустить, если освобождена
   ↓
4. Удалить на основе режима:
   - audio_only: Удалить файл, сохранить запись БД, установить audio_deleted_at
   - full_recording: Удалить файл и запись БД
   ↓
5. Вернуть статистику
```

## Руководство по миграции

### Включение автоматического удаления на существующей системе

1. **Сначала протестируйте с режимом только аудио:**
   ```bash
   ENABLE_AUTO_DELETION=true
   GLOBAL_RETENTION_DAYS=365  # Начните с длинного периода
   DELETION_MODE=audio_only   # Тестируйте безопасно
   ```

2. **Защитите существующий важный контент:**
   - Создайте защищенные теги
   - Примените к критическим записям
   - Проверьте освобождения через `/admin/auto-deletion/stats`

3. **Запустите ручной тест:**
   ```bash
   POST /admin/auto-deletion/run
   ```

4. **Отслеживайте результаты** и настройте период хранения по мере необходимости

### Откат изменений

Если вам нужно отключить автоматическое удаление:
```bash
ENABLE_AUTO_DELETION=false
```

**Примечание:** Уже удаленные аудиофайлы не могут быть восстановлены. Записи базы данных (если используется режим только аудио) остаются нетронутыми.

## Справочник API

### Запустить автоматическое удаление (Только администратор)

```http
POST /admin/auto-deletion/run
```

Вручную запустить процесс автоматического удаления.

### Получить статистику удаления (Только администратор)

```http
GET /admin/auto-deletion/stats
```

Получить статистику о подходящих записях и текущей конфигурации.

## Решение проблем

### Автоматическое удаление не запускается

**Проверьте:**
1. `ENABLE_AUTO_DELETION=true` в `.env`
2. `GLOBAL_RETENTION_DAYS > 0`
3. Статус администратора для ручных триггеров
4. Логи сервера на ошибки

### Слишком много записей удаляется

**Решения:**
1. Увеличьте `GLOBAL_RETENTION_DAYS`
2. Добавьте защищенные теги к важным категориям
3. Проверьте назначения тегов на записях
4. Просмотрите статус освобождения через эндпоинт статистики

### Архивированные записи не отображаются

**Проверьте:**
1. Переключатель фильтра "Archived Recordings" в боковой панели
2. Проверьте `DELETION_MODE=audio_only` (full_recording не архивирует)
3. Проверьте поле `audio_deleted_at` в базе данных

## Соображения безопасности

1. **Эндпоинты только для администраторов**: Триггеры автоматического удаления требуют аутентификации администратора
2. **Необратимое удаление**: Удаленные аудиофайлы не могут быть восстановлены
3. **Аудиторский след**: Проверьте логи сервера на события удаления
4. **Соответствие GDPR**: Режим полного удаления помогает соответствовать требованиям "права быть забытым"

## Поддержка

Для проблем или вопросов об автоматическом удалении:
1. Проверьте логи сервера на подробные сообщения об ошибках
2. Проверьте конфигурацию переменных окружения
3. Протестируйте с эндпоинтом `/admin/auto-deletion/stats`
4. Просмотрите эту документацию
5. Отправьте проблемы на GitHub с прикрепленными логами

---

Вернуться к [Руководству администратора](index.md) →
