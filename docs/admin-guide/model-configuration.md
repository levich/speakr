# Конфигурация моделей

Это руководство охватывает, как настроить модели ИИ для генерации текста в Speakr, включая поддержку серии GPT-5 от OpenAI и других языковых моделей.

## Обзор

Speakr использует модели ИИ для нескольких ключевых функций:

- **Генерация сводок**: Создание интеллектуальных сводок ваших транскрипций
- **Генерация заголовков**: Автоматическая генерация описательных заголовков для записей
- **Извлечение событий**: Идентификация событий, достойных календаря, из бесед
- **Интерактивный чат**: Ответы на вопросы о ваших записях
- **Идентификация говорящих**: Обнаружение имен говорящих из контекста беседы

Эти функции питаются большими языковыми моделями (LLM), настроенными через ваш файл `.env`.

## Базовая конфигурация

Модель генерации текста настраивается с использованием трех переменных окружения:

```bash
TEXT_MODEL_BASE_URL=https://openrouter.ai/api/v1
TEXT_MODEL_API_KEY=your_api_key_here
TEXT_MODEL_NAME=openai/gpt-4o-mini
```

### Выбор провайдера

**OpenRouter** (рекомендуется для большинства пользователей): Предоставляет доступ к нескольким моделям ИИ через единый API, часто по конкурентным ценам. Поддерживает GPT-4, Claude и многие другие модели. Настройте, используя `TEXT_MODEL_BASE_URL=https://openrouter.ai/api/v1`.

**OpenAI Direct**: Используйте API OpenAI напрямую для доступа к их последним моделям, включая GPT-5. Настройте, используя `TEXT_MODEL_BASE_URL=https://api.openai.com/v1`. Эта опция требуется для моделей GPT-5 с их специализированными параметрами.

**Пользовательские эндпоинты**: Speakr работает с любым API-эндпоинтом, совместимым с OpenAI, включая самодостаточные решения, такие как LocalAI, Ollama с совместимостью OpenAI, или корпоративные API-шлюзы.

## Поддержка GPT-5

Speakr полностью поддерживает семейство моделей GPT-5 от OpenAI, автоматически обнаруживая и настраивая параметры API, когда вы используете модели GPT-5 с официальным API OpenAI.

### Требования

- **OpenAI Python SDK**: Версия 2.2.0 или выше (включена в `requirements.txt`)
- **OpenAI API**: Должен использовать `TEXT_MODEL_BASE_URL=https://api.openai.com/v1`
- **Действительный ключ API**: Ключ API OpenAI с доступом к GPT-5

### Поддерживаемые модели GPT-5

- **gpt-5**: Лучше всего для сложных рассуждений, широких знаний о мире и задач, насыщенных кодом
- **gpt-5-mini**: Оптимизированные по стоимости рассуждения и чат; балансирует скорость, стоимость и возможности
- **gpt-5-nano**: Задачи с высокой пропускной способностью, особенно простое следование инструкциям
- **gpt-5-chat-latest**: Последняя модель чата GPT-5

### Ключевые отличия от GPT-4

Модели GPT-5 используют разные параметры, чем предыдущие модели:

**Неподдерживаемые параметры** (вызовут ошибки, если используются):
- `temperature` - Заменен на `reasoning_effort` и `verbosity`
- `top_p` - Не поддерживается
- `logprobs` - Не поддерживается

**Новые параметры GPT-5**:

**Reasoning Effort**: Контролирует, сколько токенов рассуждения модель генерирует перед производством ответа.

- **minimal**: Самые быстрые ответы, минимальные токены рассуждения (лучше всего для простых задач)
- **low**: Быстрые ответы с базовыми рассуждениями
- **medium**: Сбалансированные рассуждения и скорость (по умолчанию, рекомендуется)
- **high**: Максимальные рассуждения для сложных задач, таких как кодирование и многошаговое планирование

**Verbosity**: Контролирует, сколько выходных токенов генерируется.

- **low**: Краткие ответы
- **medium**: Сбалансированная детализация (по умолчанию)
- **high**: Тщательные объяснения и детальный код

**Лимиты токенов**: GPT-5 использует `max_completion_tokens` вместо `max_tokens`.

### Настройка GPT-5

Добавьте эти настройки в ваш файл `.env`:

```bash
# Используйте эндпоинт API OpenAI
TEXT_MODEL_BASE_URL=https://api.openai.com/v1
TEXT_MODEL_API_KEY=your_openai_api_key
TEXT_MODEL_NAME=gpt-5-mini

# Специфичные для GPT-5 параметры (необязательно, показаны значения по умолчанию)
GPT5_REASONING_EFFORT=medium
GPT5_VERBOSITY=medium
```

### Примеры конфигурации GPT-5

**Быстрое суммирование (низкая стоимость)**:
```bash
TEXT_MODEL_NAME=gpt-5-nano
GPT5_REASONING_EFFORT=minimal
GPT5_VERBOSITY=low
```

**Стандартное использование (рекомендуется)**:
```bash
TEXT_MODEL_NAME=gpt-5-mini
GPT5_REASONING_EFFORT=medium
GPT5_VERBOSITY=medium
```

**Сложный анализ (высокое качество)**:
```bash
TEXT_MODEL_NAME=gpt-5
GPT5_REASONING_EFFORT=high
GPT5_VERBOSITY=high
```

### Автоматическое обнаружение

Speakr автоматически обнаруживает, когда вы используете:

1. Модель GPT-5 (на основе имени модели)
2. Официальный API OpenAI (на основе базового URL, содержащего `api.openai.com`)

Когда оба условия выполнены, Speakr автоматически:

- Удаляет параметр `temperature` из API-вызовов
- Добавляет параметр `reasoning_effort`
- Добавляет параметр `verbosity`
- Использует `max_completion_tokens` вместо `max_tokens`
- Логирует, что используются параметры GPT-5

Проверьте ваши логи для подтверждения:
```
Using GPT-5 model: gpt-5-mini - applying GPT-5 specific parameters
```

### Использование GPT-5 через OpenRouter

Если вы используете модели GPT-5 через OpenRouter или другие прокси-сервисы, автоматическая обработка параметров GPT-5 **не** активируется. Эти сервисы обычно обрабатывают перевод параметров сами, поэтому Speakr использует стандартные параметры (temperature, max_tokens и т.д.).

### Случаи использования

**Суммирование**:
- Быстрые сводки: `gpt-5-nano` с `minimal` усилием и `low` verbosity
- Стандартные сводки: `gpt-5-mini` с `medium` усилием и `medium` verbosity
- Детальные сводки: `gpt-5` с `medium` усилием и `high` verbosity

**Чат**:
- Быстрые вопросы и ответы: `gpt-5-mini` с `minimal` усилием и `low` verbosity
- Стандартная беседа: `gpt-5-mini` с `low` усилием и `medium` verbosity
- Сложный анализ: `gpt-5` с `high` усилием и `medium` verbosity

### Решение проблем GPT-5

**Ошибка: "Unsupported parameter 'temperature'"**

Это означает, что обнаружение GPT-5 не удалось. Проверьте, что:

1. `TEXT_MODEL_BASE_URL` содержит `api.openai.com`
2. `TEXT_MODEL_NAME` начинается с `gpt-5` или является одним из: `gpt-5`, `gpt-5-mini`, `gpt-5-nano`, `gpt-5-chat-latest`

**Ошибка: "Invalid reasoning_effort value"**

Допустимые значения: `minimal`, `low`, `medium`, `high`

**Ошибка: "Invalid verbosity value"**

Допустимые значения: `low`, `medium`, `high`

### Миграция с GPT-4 на GPT-5

1. **Обновите зависимости** (требуется для GPT-5):
   ```bash
   pip install -r requirements.txt
   ```
   Это обновляет OpenAI SDK до версии 2.2.0 или выше.

2. Обновите ваш файл `.env`:
   ```bash
   TEXT_MODEL_NAME=gpt-5-mini  # или gpt-5, gpt-5-nano
   ```

3. Добавьте параметры GPT-5 (необязательно):
   ```bash
   GPT5_REASONING_EFFORT=medium
   GPT5_VERBOSITY=medium
   ```

4. Перезапустите Speakr:
   ```bash
   docker compose restart
   ```

5. Проверьте логи для подтверждения:
   ```
   Using GPT-5 model: gpt-5-mini - applying GPT-5 specific parameters
   ```

### Соображения производительности

- **Стоимость**: `gpt-5-nano` < `gpt-5-mini` < `gpt-5`
- **Скорость**: `minimal` < `low` < `medium` < `high` reasoning effort
- **Качество**: Обычно увеличивается с размером модели и reasoning effort
- **Использование токенов**: Более высокая verbosity = больше выходных токенов

Для большинства случаев использования мы рекомендуем:
- **Модель**: `gpt-5-mini`
- **Рассуждения**: `medium`
- **Verbosity**: `medium`

Это обеспечивает хороший баланс стоимости, скорости и качества.

## Руководящие принципы выбора модели

### Для сводок

Модель, которую вы выбираете, значительно влияет на качество сводок:

- **GPT-4 или лучше**: Производит нюансные, контекстно-осознанные сводки с отличным пониманием сложных тем
- **GPT-5-mini**: Отличный баланс качества и стоимости для большинства потребностей в суммировании
- **GPT-3.5/4o-mini**: Бюджетный вариант, подходящий для прямолинейного контента
- **Модели Claude**: Сильная производительность на структурированном контенте и техническом материале

### Для чата

Функции чата выигрывают от более способных моделей:

- **GPT-5**: Лучше всего для сложных многоходовых бесед и детального анализа
- **GPT-5-mini**: Рекомендуется для большинства случаев использования чата
- **Claude**: Отлично для технических обсуждений и запросов, связанных с кодом

### Оптимизация стоимости

Чтобы снизить затраты, поддерживая качество:

1. **Используйте меньшие модели для простых задач**: `gpt-5-nano` или `gpt-4o-mini` хорошо обрабатывают прямолинейные сводки
2. **Настройте reasoning effort GPT-5**: Используйте `minimal` или `low` для быстрых задач
3. **Установите лимиты токенов**: Настройте `SUMMARY_MAX_TOKENS` и `CHAT_MAX_TOKENS` в вашем `.env`
4. **Используйте OpenRouter**: Часто предоставляет лучшие тарифы, чем прямой доступ к API

### Тестирование конфигурации

После изменения конфигурации модели:

1. Перезапустите контейнер Speakr
2. Создайте тестовую запись
3. Просмотрите сгенерированную сводку и заголовок
4. Протестируйте функцию чата
5. Отслеживайте логи на наличие ошибок или предупреждений

## Справочник переменных окружения

```bash
# Обязательно: API эндпоинт
TEXT_MODEL_BASE_URL=https://api.openai.com/v1

# Обязательно: Ключ API
TEXT_MODEL_API_KEY=your_api_key_here

# Обязательно: Идентификатор модели
TEXT_MODEL_NAME=gpt-5-mini

# Необязательно: Максимальные токены для сводок (по умолчанию: 8000)
SUMMARY_MAX_TOKENS=8000

# Необязательно: Максимальные токены для ответов чата (по умолчанию: 2000)
CHAT_MAX_TOKENS=2000

# Специфично для GPT-5 (используется только с моделями GPT-5 и API OpenAI)
GPT5_REASONING_EFFORT=medium  # minimal, low, medium, high
GPT5_VERBOSITY=medium          # low, medium, high
```

## Решение проблем

### Модель не отвечает

Проверьте логи на ошибки аутентификации:
```bash
docker compose logs -f app | grep "LLM"
```

Распространенные проблемы:
- Недействительный ключ API
- Имя модели недоступно в вашем плане
- Превышены лимиты скорости
- Недостаточно кредитов

### Плохое качество сводок

Попробуйте эти корректировки:
- Обновитесь до более способной модели
- Увеличьте `SUMMARY_MAX_TOKENS`
- Просмотрите и уточните [пользовательские промпты](prompts.md)
- Для GPT-5: увеличьте reasoning effort до `medium` или `high`

### Высокие затраты

Снизьте затраты с помощью:
- Переключитесь на меньшие модели (`gpt-5-nano`, `gpt-4o-mini`)
- Снизьте лимиты токенов
- Для GPT-5: уменьшите reasoning effort до `minimal` или `low`
- Используйте OpenRouter для лучших тарифов

## Дополнительные ресурсы

- [Документация OpenAI GPT-5](https://platform.openai.com/docs/guides/latest-model)
- [API OpenAI Chat Completions](https://platform.openai.com/docs/api-reference/chat)
- [Документация OpenRouter](https://openrouter.ai/docs)
- [Руководство по пользовательским промптам](prompts.md)
- [Системные настройки](system-settings.md)

---

Далее: [Промпты по умолчанию](prompts.md) | Назад к [Руководству администратора](index.md)
